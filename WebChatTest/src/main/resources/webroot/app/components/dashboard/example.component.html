<div class="main">

  <div *ngIf="empty && static" id="selection-segment" class="ui segment">
    <div class="ui message">
      <div class="header">
        Comparative Dashboard
      </div>
      <p>Click <b>Upload</b> to see your results or <b>View</b> to see default results.</p>
    </div>
    <div class="ui fluid large buttons">
      <button class="ui button teal" (click)="selectMode(true)">
          <i class="cloud upload icon"></i>
          Upload
      </button>
      <div class="or"></div>
      <button class="ui button" (click)="selectMode(false)">
          <i class="unhide icon"></i>
          View
      </button>
    </div>
  </div>

  <div id="appDef" class="ui modal">
    <div class="header center-text">Application detail</div>
    <div class="content">
      <h1 class="ui header" [ngStyle]="{ color : getColor(selectedApp.index) }">{{ selectedApp.name }}</h1>
      <div class="description">
        <p class="huge-font">{{ selectedApp.globalDefinition }}</p>
        <p class="huge-font">{{ selectedApp.specificDefinition }}</p>
        <div class="ui buttons fluid">
          <button class="ui button" (click)="exportToJSON(selectedApp.name)">Download all data</button>
          <button *ngFor="let key of graphics | keys" class="ui button" (click)="exportToJSON(selectedApp.name, graphics[key].chatSize)">
            Download {{ graphics[key].chatSize }} room(s)
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="empty && !local && !static" class="loader">
    <div class="inner one"></div>
    <div class="inner two"></div>
    <div class="inner three"></div>
    <div class="text">{{ loading_text }}</div>
  </div>


  <div class="ui one column grid">

    <!-- UPLOAD DATA -->

    <div id="upload-data" class="column" *ngIf="uploadData">
      <div class="ui segment load-box-init">
        <h2 class="ui icon header" style="width: 100%;">
          <div class="content">
            WebChatTest
            <div class="sub header">No server running</div>
          </div>
        </h2>
        <div class="ui message">
          <div class="header">
            Upload save data to display graphics
          </div>
          <ul class="list">
            <li>Can upload multiple files</li>
            <li>Only .json files generated by this application can be upload</li>
          </ul>
        </div>
        <div class="ui segment secondary">
          <input type="file" filesread="onChange" multiple/>
          <div *ngIf="results.length == 0" class="ui horizontal divider">Or</div>
          <div *ngIf="results.length == 0" id="drop_area" class="drop-area">Drop your files here!</div>
          <div id="result"></div>
        </div>
        <button *ngIf="results.length > 0" [ngClass]="empty ? 'load-button-init':'load-button-final'" class="ui button" (click)="loadResults()">Load files</button>
      </div>
    </div>

    <!-- CHARTS -->
    <div *ngIf="!empty" class="column">
      <div class="ui stackable menu">
        <a class="item title">
          Web Chat Test
        </a>
        <div *ngFor="let key of apps | keys; let j = index" class="ui floating labeled icon dropdown item">
          <div  id="{{ apps[key].name }}" [ngStyle]="{ color : getColor(j) }" (click)="openModal(apps[key])">
            <span class="text">{{ apps[key].name }}</span>
          </div>
        </div>
        <div class="right menu">
          <a class="ui item" (click)="generateDocument()">
            <i class="file text outline icon"></i>
            Generate comparative report
          </a>
        </div>
      </div>
    </div>

    <div *ngFor="let key of graphics | keys" class="column hide">
      <div class="ui top attached segment">
        <button (click)="slideDown(graphics[key])" class="ui basic icon button drop">
          <i class="chevron icon" [ngClass]="graphics[key].visible ? 'down' : 'right' "></i>
        </button>
        <!-- <button (click)="exportToPDF(graphics[key])" class="ui basic icon button export-button">
          <i class="file pdf outline icon"></i>
          Export to PDF
        </button> -->
        <button (click)="saveImg(graphics[key])" class="ui basic icon button export-button">
          <i class="file image outline icon"></i>
          Download current graphic
        </button>
        <button (click)="saveData(graphics[key])" class="ui basic icon button export-button">
          <i class="file excel outline icon"></i>
          Download data in .xls
        </button>
        <h2 class="ui header">{{ graphics[key].title }}</h2>
      </div>



      <div id="{{graphics[key].chatSize}}" class="ui two column grid stackable attached segment">
        <!-- GRAPHIC -->
        <div class="column">

          <div class="chart-canvas" [ngClass]="{ 'hide' : graphics[key].tab != 0 && !showAll }">
            <canvas baseChart
            id="{{graphics[key].chatSize +'-size-times'}}"
            [datasets]="graphics[key].dataTimes"
            [labels]="graphics[key].labels"
            [colors]="colors"
            [legend]="true"
            [chartType]="'line'"
            [options]="timeOptions"
            ></canvas>
          </div>

          <div class="chart-canvas" [ngClass]="{ 'hide' : graphics[key].tab != 1 && !showAll }">
            <canvas baseChart
            id="{{graphics[key].chatSize +'-size-cpu'}}"
            [datasets]="graphics[key].dataCpuUse"
            [labels]="graphics[key].labels"
            [colors]="colors"
            [legend]="true"
            [chartType]="'line'"
            [options]="cpuOptions"
            ></canvas>
          </div>

          <div class="chart-canvas" [ngClass]="{ 'hide' : graphics[key].tab != 2 && !showAll }">
            <canvas baseChart
            id="{{graphics[key].chatSize +'-size-memory'}}"
            [datasets]="graphics[key].dataMemoryUse"
            [labels]="graphics[key].labels"
            [colors]="colors"
            [legend]="true"
            [chartType]="'line'"
            [options]="memoryOptions"
            ></canvas>
          </div>

          <div *ngIf="graphics[key].tab == 1" class="ui visible message">
            <p>* Exceeds 100% if the machine has more than one core</p>
          </div>
        </div>

        <div class="column">

          <!-- METRIC SELECTOR -->
          <div class="ui form">
            <div class="field">
                <label>Select a metric</label>
                <div id="selectMetric{{graphics[key].chatSize}}" class="ui selection dropdown metrics-menu" (click)="dropdown('#selectMetric'+graphics[key].chatSize)">
                  <input type="hidden">
                  <i class="dropdown icon"></i>
                  <div class="default text">{{ graphics[key].current_tab }}</div>
                  <div class="menu">
                    <div class="item" (click)="graphics[key].current_tab = 'Response time'; graphics[key].tab = 0;">Response time</div>
                    <div class="item" (click)="graphics[key].current_tab = 'CPU use'; graphics[key].tab = 1;">CPU use</div>
                    <div class="item" (click)="graphics[key].current_tab = 'Memory use'; graphics[key].tab = 2;">Memory use</div>
                  </div>
                </div>
            </div>
          </div>

          <!-- DATA -->
          <table class="ui celled table">
            <thead style="text-align: center; ">
              <tr>
                <th rowspan="2">App</th>
                <th *ngIf="graphics[key].tab == 0" [colSpan]="graphics[key].labels.length">Number of messages / time (in ms)</th>
                <th *ngIf="graphics[key].tab == 1" [colSpan]="graphics[key].labels.length">Number of messages / % CPU use</th>
                <th *ngIf="graphics[key].tab == 2" [colSpan]="graphics[key].labels.length">Number of messages / memory use (in KBytes)</th>
              </tr>
              <tr>
                <th *ngFor="let label of graphics[key].labels">{{ label }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let app of graphics[key].series; let j = index">
                <td class="app-name" [ngStyle]="{ color : getColor(j) }">{{ app }}</td>
                <td *ngFor="let metric of getData(graphics[key], graphics[key].tab, j)" [hidden]="graphics[key].tab == 0" class="metric" >{{ metric }}</td>
                <td *ngFor="let metric of getData(graphics[key], graphics[key].tab, j)" [hidden]="graphics[key].tab > 0" class="metric" >{{ metric }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>






<!-- TO PRINT -->
<!-- <div id="toPrint" *ngIf="false">
  <style>
    /* To print only 1 page */
    @media print {
      html, body {
        height: 90%;
      }
      body{
        margin-left: 2%;
        margin-right: 2%;
      }
    }
    td{
      text-align: center !important;
    }
    .ui.celled.table tr th:first-child, .ui.celled.table tr td:first-child {
        border-left: 1px solid rgba(34, 36, 38, 0.1) !important;
    }
  </style>
  <h1 class="ui header" style="text-align: center; margin-top: 1.5em; margin-bottom: 1em;">
    {{ currentgraphics[key].title }}
    <div class="sub header">Results report</div>
  </h1>
  <div id="{{currentItem.chatSize +'-size-paste'}}" class="column" style="width: 40%;">
    <img *ngIf="chart_img" [src]="{{ chart_img }}"/>
  </div>
  <div style="margin-top: 2em;">
    <table class="ui celled table">
      <thead style="text-align: center; ">
        <tr>
          <th rowspan="2">App</th>
          <th [colSpan]="currentItem.labels.length">Number of messages / time (en ms)</th>
        </tr>
        <tr>
          <th *ngFor="let label of currentItem.labels track by $index">{{ label }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let app ofcurrentItem.series track by $index">
          <td>{{ app }}</td>
          <td *ngFor="let avgTime of getData(currentItem, currentItem.tab, $index) track by $index">{{ avgTime }}</td>
        </tr>
      </tbody>
    </table>

  </div>
</div> -->

<!-- TO DOWNLOAD XLS -->
<table *ngFor="let tab of [0,1,2]" class="ui celled table" id="xls-results-{{ dataKeys[tab] }}" [hidden]="true">
  <thead style="text-align: center; ">
    <tr>
      <th rowspan="2">Aplication</th>
      <th [colSpan]="currentItem.labels.length">Number of users per room / {{ dataKeysDescription[tab] }}</th>
    </tr>
    <tr>
      <th *ngFor="let label of currentItem.labels">{{ label }}</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let app of currentItem.series; let i = index">
      <td>{{ app }}</td>
      <td *ngFor="let avgTime of getData(currentItem, tab, i)">{{ avgTime }}</td>
    </tr>
  </tbody>
</table>

<!-- TO DOWNLOAD REPORT -->
<div id="comparativeReport" >
  <div class="main">
  <div id="menu" class="column">
    <div class="ui stackable menu">
      <a class="item title">
        Comparative Report
      </a>

      <div *ngFor="let key of apps | keys; let i = index;" class="ui floating labeled icon dropdown item app-detail"  [ngStyle]="{ color : getColor(i) }" id="{{ apps[key].name }}_report">
        <span  class="text">{{ apps[key].name }}</span>
        <div class="ui popup bottom left transition hidden" style="top: 554px; left: 1px; bottom: auto; right: auto; width: 25em; max-width: 50em !important;">
          <h1 class="ui header" [ngStyle]="{ color : getColor(apps[key].index) }">{{ apps[key].name }}</h1>
          <p class="huge-font">{{ apps[key].globalDefinition }}</p>
          <p class="huge-font">{{ apps[key].specificDefinition }}</p>
        </div>
      </div>
    </div>
  </div>

  <div *ngFor="let key of graphics | keys" class="column graphic">
    <div class="ui top attached segment">
      <h2 class="ui header">{{ graphics[key].title }}</h2>
    </div>

    <div id="{{graphics[key].chatSize}}" class="ui two column grid stackable attached segment">

      <div class="column">
        <img id="{{graphics[key].chatSize + 'times'}}" class="ui fluid image" [src]="getGraphImg(graphics[key],'times')"/>
        <img id="{{graphics[key].chatSize + 'cpu'}}" class="ui fluid image" [src]="getGraphImg(graphics[key],'cpu')" style="display: none;"/>
        <img id="{{graphics[key].chatSize + 'memory'}}" class="ui fluid image" [src]="getGraphImg(graphics[key],'memory')" style="display: none;"/>
        <div class="ui message" style="display: none;">
          <p>* Exceeds 100% if the machine has more than one core</p>
        </div>
      </div>

      <div class="column">
        <div class="ui form">
          <div class="field">
              <label>Select a metric</label>
              <div id="selectMetric{{graphics[key].chatSize}}" class="ui selection dropdown metrics-menu" onClick="dropdown(this)">
                <input type="hidden">
                <i class="dropdown icon"></i>
                <div class="default text">Response time</div>
                <div class="menu">
                  <div class="item" [attr.chat-size]="graphics[key].chatSize" onClick="select(this,'times', 'Response time')">Response time</div>
                  <div class="item" [attr.chat-size]="graphics[key].chatSize" onClick="select(this,'cpu', 'CPU use')">CPU use</div>
                  <div class="item" [attr.chat-size]="graphics[key].chatSize" onClick="select(this,'memory', 'Memory use')">Memory use</div>
                </div>
              </div>
          </div>
        </div>


        <table id="table-{{graphics[key].chatSize}}-times" class="ui celled table unstackable">
          <thead style="text-align: center; ">
            <tr>
              <th rowspan="2">App</th>
              <th [colSpan]="graphics[key].labels.length">Number of user per room / time (in ms)</th>
            </tr>
            <tr>
              <th *ngFor="let label of graphics[key].labels">{{ label }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let app of graphics[key].series; let i = index;">
              <td class="app-name" [ngStyle]="{ color : getColor(i) }">{{ app }}</td>
              <td class="metric" *ngFor="let metric of getData(graphics[key], 0, i)">{{ metric }}</td>
            </tr>
          </tbody>
        </table>

        <table id="table-{{graphics[key].chatSize}}-cpu" class="ui celled table unstackable" style="display: none;">
          <thead style="text-align: center; ">
            <tr>
              <th rowspan="2">App</th>
              <th [colSpan]="graphics[key].labels.length">Number of user per room / % CPU use</th>
            </tr>
            <tr>
              <th *ngFor="let label of graphics[key].labels">{{ label }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let app of graphics[key].series; let i = index;">
              <td class="app-name" [ngStyle]="{ color : getColor(i) }">{{ app }}</td>
              <td class="metric" *ngFor="let metric of getData(graphics[key], 1, i)">{{ metric }}</td>
            </tr>
          </tbody>
        </table>

        <table id="table-{{graphics[key].chatSize}}-memory" class="ui celled table unstackable" style="display: none;">
          <thead style="text-align: center; ">
            <tr>
              <th rowspan="2">App</th>
              <th [colSpan]="graphics[key].labels.length">Number of user per room / % memory use</th>
            </tr>
            <tr>
              <th *ngFor="let label of graphics[key].labels">{{ label }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let app of graphics[key].series; let i = index;">
              <td class="app-name" [ngStyle]="{ color : getColor(i) }">{{ app }}</td>
              <td class="metric" *ngFor="let metric of getData(graphics[key], 2, i)">{{ metric }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
  </div>
</div>

</div>
